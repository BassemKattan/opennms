<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0"
           xmlns:cxf="http://cxf.apache.org/blueprint/core"
           xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
           xsi:schemaLocation="
		http://www.osgi.org/xmlns/blueprint/v1.0.0
		http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.3.0
		http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.3.0.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0
		http://aries.apache.org/schemas/blueprint-ext/blueprint-ext-1.5.xsd">

    <!-- Load system properties -->
    <ext:property-placeholder />


    <!-- service imports DAOs (services et al) -->
    <reference id="alarmDao" interface="org.opennms.netmgt.dao.api.AlarmDao" />
    <reference id="sessionUtils" interface="org.opennms.netmgt.dao.api.SessionUtils" />
    <reference id="eventForwarder" interface="org.opennms.netmgt.events.api.EventForwarder" />
    <reference id="alarmEntityNotifier" interface="org.opennms.netmgt.dao.api.AlarmEntityNotifier" />
    <reference id="assetRecordDao" interface="org.opennms.netmgt.dao.api.AssetRecordDao" />
    <reference id="eventDao" interface="org.opennms.netmgt.dao.api.EventDao" />
    <reference id="ipInterfaceDao" interface="org.opennms.netmgt.dao.api.IpInterfaceDao" />
    <reference id="nodeDao" interface="org.opennms.netmgt.dao.api.NodeDao" />
    <reference id="hwEntityDao" interface="org.opennms.netmgt.dao.api.HwEntityDao" />
    <reference id="eventSubscriptionService" interface="org.opennms.netmgt.events.api.EventSubscriptionService" />
    <reference id="acknowledgmentDao" interface="org.opennms.netmgt.dao.api.AcknowledgmentDao" />
    <reference id="eventProxy" interface="org.opennms.netmgt.events.api.EventProxy"/>


    <!-- drools integration -->
    <bean id="defaultAlarmService" class="org.opennms.netmgt.alarmd.drools.DefaultAlarmService">
        <property name="acknowledgmentDao" ref="acknowledgmentDao" />
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventForwarder" ref="eventForwarder" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>

    <bean id="defaultAlarmTicketerService" class="org.opennms.netmgt.alarmd.drools.DefaultAlarmTicketerService">
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventForwarder" ref="eventForwarder" />
    </bean>

    <bean id="droolsAlarmContext" class="org.opennms.netmgt.alarmd.drools.DroolsAlarmContext">
        <property name="acknowledgmentDao" ref="acknowledgmentDao" />
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmService" ref="defaultAlarmService" />
        <property name="alarmTicketerService" ref="defaultAlarmTicketerService" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>
    <service id="alarmLifecycleListener" ref="droolsAlarmContext" interface="org.opennms.netmgt.alarmd.api.AlarmLifecycleListener" />


    <!-- daemon -->
    <bean id="metricRegistry" class="com.codahale.metrics.MetricRegistry" />
    <bean id="eventUtil" class="org.opennms.netmgt.eventd.EventUtilDaoImpl">
        <argument ref="metricRegistry" />
        <property name="nodeDao" ref="nodeDao" />
        <property name="assetRecordDao" ref="assetRecordDao" />
        <property name="ipInterfaceDao" ref="ipInterfaceDao" />
        <property name="hwEntityDao" ref="hwEntityDao" />
    </bean>
    <bean id="alarmPersister" class="org.opennms.netmgt.alarmd.AlarmPersisterImpl">
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventDao" ref="eventDao" />
        <property name="eventUtil" ref="eventUtil" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>

    <reference-list id="alarmPersisterExtensions" interface="org.opennms.netmgt.alarmd.api.AlarmPersisterExtension" availability="optional" >
        <reference-listener ref="alarmPersister" bind-method="onExtensionRegistered" unbind-method="onExtensionUnregistered" />
    </reference-list>
    <bean id="northbounderManager" class="org.opennms.netmgt.alarmd.NorthbounderManager">
        <property name="eventProxy" ref="eventProxy" />
    </bean>
    <service id="alarmEntityListenerService" interface="org.opennms.netmgt.dao.api.AlarmEntityListener" ref="northbounderManager"/>
    <reference-list interface="org.opennms.netmgt.alarmd.api.Northbounder" availability="optional" >
        <reference-listener ref="northbounderManager" bind-method="onNorthbounderRegistered" unbind-method="onNorthbounderUnregistered" />
    </reference-list>
    <bean id="alarmLifecycleListenerManager" class="org.opennms.netmgt.alarmd.AlarmLifecycleListenerManager" init-method="afterPropertiesSet" >
        <property name="alarmDao" ref="alarmDao" />
        <property name="sessionUtils" ref="sessionUtils" />
        <property name="listener" ref="droolsAlarmContext" /> <!-- TODO check with group -->
    </bean>
    <bean id="daemon" class="org.opennms.netmgt.alarmd.Alarmd" init-method="onStart" destroy-method="onStop">
        <property name="persister" ref="alarmPersister" />
        <property name="droolsAlarmContext" ref="droolsAlarmContext" />
        <property name="alarmLifecycleListenerManager" ref="alarmLifecycleListenerManager" />
        <property name="northbounderManager" ref="northbounderManager" />
    </bean>

    <bean id="daemonListener" class="org.opennms.netmgt.events.api.AnnotationBasedEventListenerAdapter" init-method="afterPropertiesSet" destroy-method="destroy">
        <property name="annotatedListener" ref="daemon" />
        <property name="eventSubscriptionService" ref="eventSubscriptionService" />
    </bean>

    <service interface="org.opennms.netmgt.dao.api.AlarmEntityListener" ref="alarmLifecycleListenerManager">
        <service-properties>
            <entry key="registration.export" value="true" />
        </service-properties>
    </service>

    <!-- can one export and import a service in the same blueprint ? -->
    <reference-list id="alarmLifecycleListeners" interface="org.opennms.netmgt.alarmd.api.AlarmLifecycleListener" availability="optional">
        <reference-listener ref="alarmLifecycleListenerManager" bind-method="onListenerRegistered" unbind-method="onListenerUnregistered" />
    </reference-list>


</blueprint>