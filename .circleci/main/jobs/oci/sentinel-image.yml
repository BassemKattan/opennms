jobs:
  sentinel-image:
    machine:
      image: ubuntu-2004:202010-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
      - attach_workspace: 
          at: ~/
      - fetch-artifacts:
          path: ~/project/target/debs
          location: sentineldebs
      - run:
          name: Build Sentinel OCI
          command: |
            cd opennms-container/sentinel
 
            # Create always a downloadable single OCI artifact for AMD architecture.
            # This image is used in our integration test suite which relies on the tag "sentinel:latest".
            make VERSION="$(../pom2version.py ../../pom.xml)" \
                 DOCKER_TAG="sentinel:latest" \
                 BUILD_NUMBER="${CIRCLE_BUILD_NUM}" \
                 BUILD_URL="${CIRCLE_BUILD_URL}" \
                 BUILD_BRANCH="${CIRCLE_BRANCH}"
      - store_artifacts:
          path: ~/project/opennms-container/sentinel/images/
          destination: /
      - cache-oci:
          key: sentinel
          path: opennms-container/sentinel/images/
      - persist_to_workspace:
          root: ~/
          paths:
            - project/opennms-assemblies/sentinel/target/org.opennms.assemblies.sentinel-*-sentinel.tar.gz