<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0
		http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0
		http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd">

    <reference id="twinSubscriber" interface="org.opennms.core.ipc.twin.api.TwinSubscriber" />

    <!-- Classification Engine -->
    <bean id="defaultClassificationEngine" class="org.opennms.netmgt.flows.classification.internal.DefaultClassificationEngine" />
    <bean id="timingClassificationEngine" class="org.opennms.netmgt.flows.classification.internal.TimingClassificationEngine">
        <argument ref="classificationMetricRegistry"/>
        <argument ref="defaultClassificationEngine" />
    </bean>
    <bean id="asyncReloadingClassificationEngine" class="org.opennms.netmgt.flows.classification.internal.AsyncReloadingClassificationEngine">
        <argument ref="timingClassificationEngine" />
    </bean>
    <bean id="twinClassificationEngine" class="org.opennms.netmgt.flows.classification.internal.TwinClassificationEngine">
        <argument ref="asyncReloadingClassificationEngine" />
        <argument ref="twinSubscriber" />
    </bean>

    <!-- Metrics -->
    <bean id="classificationMetricRegistry" class="com.codahale.metrics.MetricRegistry"/>

    <bean id="classificationMetricRegistryJmxReporterBuilder" class="com.codahale.metrics.JmxReporter" factory-method="forRegistry">
        <argument ref="classificationMetricRegistry"/>
    </bean>
    <bean id="classificationMetricRegistryDomainedJmxReporterBuilder" factory-ref="classificationMetricRegistryJmxReporterBuilder" factory-method="inDomain">
        <argument value="org.opennms.netmgt.flows.classifications"/>
    </bean>
    <bean id="classificationMetricRegistryJmxReporter"
          factory-ref="classificationMetricRegistryDomainedJmxReporterBuilder"
          factory-method="build"
          init-method="start"
          destroy-method="stop" />

    <!-- Expose Services -->
    <service interface="org.opennms.netmgt.flows.classification.ClassificationEngine" ref="twinClassificationEngine"/>
</blueprint>
