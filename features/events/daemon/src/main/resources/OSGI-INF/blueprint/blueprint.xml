<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.3.0"
           xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0"
           xsi:schemaLocation="
		http://www.osgi.org/xmlns/blueprint/v1.0.0
		hteventIpcManagerImpltps://osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.3.0
		http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.3.0.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0
		http://aries.apache.org/schemas/blueprint-ext/blueprint-ext-1.5.xsd">


    <!-- service import -->
    <reference id="assetRecordDao" interface="org.opennms.netmgt.dao.api.AssetRecordDao" />
    <reference id="hwEntityDao" interface="org.opennms.netmgt.dao.api.HwEntityDao" />
    <reference id="monitoringSystemDao" interface="org.opennms.netmgt.dao.api.MonitoringSystemDao" />
    <reference id="sessionUtils" interface="org.opennms.netmgt.dao.api.SessionUtils" />
    <reference id="ipInterfaceDao" interface="org.opennms.netmgt.dao.api.IpInterfaceDao" />
    <reference id="distPollerDao" interface="org.opennms.netmgt.dao.api.DistPollerDao" />
    <reference id="nodeDao" interface="org.opennms.netmgt.dao.api.NodeDao" />
    <reference id="serviceTypeDao" interface="org.opennms.netmgt.dao.api.ServiceTypeDao" />
    <reference id="eventDao" interface="org.opennms.netmgt.dao.api.EventDao" />


    <bean id="eventUtil" class="org.opennms.netmgt.eventd.EventUtilDaoImpl">
        <argument ref="eventdMetricRegistry" />
        <property name="nodeDao" ref="nodeDao" />
        <property name="assetRecordDao" ref="assetRecordDao" />
        <property name="ipInterfaceDao" ref="ipInterfaceDao" />
        <property name="hwEntityDao" ref="hwEntityDao" />
    </bean>

    <!-- Load system property -->
    <ext:property-placeholder />

    <!--
    feature:repo-add mvn:org.opennms.karaf/opennms/29.0.0-SNAPSHOT/xml/features
    feature:repo-add mvn:org.opennms.karaf/opennms/29.0.0-SNAPSHOT/xml/spring
    feature:repo-add mvn:org.opennms.karaf/opennms/29.0.0-SNAPSHOT/xml/spring-legacy
    feature:repo-add mvn:org.opennms.karaf/opennms/29.0.0-SNAPSHOT/xml/sentinel
    -->
    <!-- system:property opennms.home /Users/markcbordelon/Documents/clodovicus/opennms/opennms/opennms-base-assembly/target/classes  -->
    <bean id="eventConfResourceLocation" class="java.lang.String">
        <!-- <argument value="file:${opennms.home}/etc/eventconf.xml" /> -->
        <argument value="/Users/markcbordelon/Documents/clodovicus/opennms/opennms/opennms-base-assembly/target/classes/etc/eventconf.xml" />
    </bean>

    <bean id="eventConfDao" class="org.opennms.netmgt.config.DefaultEventConfDao" init-method="afterPropertiesSet">
        <property name="configResourcePath" ref="eventConfResourceLocation" />
    </bean>

    <bean id="eventExpander" class="org.opennms.netmgt.eventd.EventExpander">
        <argument ref="eventdMetricRegistry"/>
        <property name="eventConfDao" ref="eventConfDao"/>
        <property name="eventUtil" ref="eventUtil"/>
    </bean>



    <bean id="eventWriter" class="org.opennms.netmgt.eventd.processor.HibernateEventWriter">
        <argument ref="eventdMetricRegistry"/>
        <property name="nodeDao" ref="nodeDao" />
        <property name="eventUtil" ref="eventUtil" />
        <property name="distPollerDao" ref="distPollerDao" />
        <property name="eventDao" ref="eventDao" />
        <property name="monitoringSystemDao" ref="monitoringSystemDao" />
        <property name="serviceTypeDao" ref="serviceTypeDao" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>



    <bean id="eventdMetricRegistry" class="com.codahale.metrics.MetricRegistry" />

    <bean id="eventIpcBroadcastProcessor" class="org.opennms.netmgt.eventd.processor.EventIpcBroadcastProcessor">
        <argument ref="eventdMetricRegistry"/>
        <property name="eventIpcBroadcaster" ref="eventIpcManagerImpl"/>
    </bean>

    <bean id="eventdConfigManager" class="org.opennms.netmgt.config.EventdConfigManager"/>
    <bean id="shouldLogEventSummaries" factory-ref="eventdConfigManager" factory-method="shouldLogEventSummaries"/>
    <bean id="eventdEventHandler" class="org.opennms.netmgt.eventd.DefaultEventHandlerImpl" init-method="afterPropertiesSet">
        <argument ref="eventdMetricRegistry"/>
        <property name="eventProcessors">
            <list>
                <!--
                  This EventProcessor can be used to perform regex replacements on incoming parm values.
                  It was added in 1.11 and because of performance concerns, it is commented-out for now.
                -->
                <!-- <ref bean="eventParmRegexFilter"/> -->
                <ref component-id="eventExpander"/>
                <ref component-id="eventWriter"/> <!--HibernateEventWriter -->
                <ref component-id="eventIpcBroadcastProcessor"/>
            </list>
        </property>
        <property name="logEventSummaries" ref="shouldLogEventSummaries" />
        <property name="nodeDao" ref="nodeDao" />
    </bean>


    <bean id="eventIpcManagerHandlerPoolSize" factory-ref="eventdConfigManager" factory-method="getReceivers"/>
    <bean id="eventIpcManagerHandlerQueueLength" factory-ref="eventdConfigManager" factory-method="getQueueLength"/>

    <bean id="eventIpcManagerImpl" class="org.opennms.netmgt.eventd.EventIpcManagerDefaultImpl" init-method="afterPropertiesSet"> <!-- EventIpcManagerDefaultImpl = sub-interface of EventForwarder -->
        <argument ref="eventdMetricRegistry"/>
        <property name="handlerPoolSize" ref="eventIpcManagerHandlerPoolSize"/>
        <property name="handlerQueueLength" ref="eventIpcManagerHandlerQueueLength"/>
        <property name="eventHandler" ref="eventdEventHandler"/>
    </bean>


    <service interface="org.opennms.netmgt.events.api.EventForwarder" ref="eventIpcManagerImpl" />

    <!-- moreover, expose the only missing Dao reference that is needed for the shell commands -->
    <service interface="org.opennms.netmgt.config.api.EventConfDao" ref="eventConfDao" />

</blueprint>