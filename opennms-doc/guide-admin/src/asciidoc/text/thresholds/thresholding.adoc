
// Allow GitHub image rendering
:imagesdir: ../../../images

[[ga-threshd-introduction]]
= Thresholding

Thresholding allows you to define triggers against any numeric data retrieved by the SNMP collector [other data collectors?], and from those triggers, generate events, notifications, and alarms. 
_{opennms-product-name}_ uses four thresholding techniques (algorithms):

* *Low* - triggers when value of the data source equals or drops below the threshold value and rearms when it equals or comes back up above the rearm value (e.g., available disk space falls under the specified value)
* *High* - triggers when the value of the data source equals or exceeds the threshold value, and rearms when it equals or drops below the rearm value (e.g., bandwidth use exceeds the specified amount)
* *Absolute* - measured value changes by specified amount (e.g., on a fiber-optic link, a change in loss of anything greater than 3 dB is a problem)
* *Relative* - measured value changes by percent (e.g., did the available disk space change more than 5% from the last poll)

These thresholds can be *basic* (tested against a single value) or an *expression* (evaluated against multiple values in an expression).

[_{opennms-product-name}_ has the ability to monitor the performance of a managed entity's resource(s) by using various thresholding techniques.
These techniques, or algorithms, can be applied against any performance data (telemetry) that has been collected by <<ga-performance-mgmt,collectd>> or has been pushed to <<ga-telemetryd, telemetryd>>.
This includes, but is not limited to metrics such as CPU load, bandwidth, disk space, etc.]

[[threshold-bw]]
=== Basic Walkthrough â€“ Thresholding

This section describes how to create a basic threshold for a single, system-wide variable: the number of logged-in users. 
Our threshold will tell OpenNMS to create an event when the number of logged in users exceeds two, and rearm when it falls below two. 

==== Determine That You are Collecting the Metric
In this case, we have chosen a metric (number of logged-in users) that is collected by default. 
We are also using data collected via SNMP. 

. In OpenNMS, choose `Reports>Resource Graphs`.
. Select one of the listed resources [how do they know?]
. Under `SNMP Node Data`, select `Node-leve Performance Data` and choose `Graph Selection`.
. Scroll to find the *Number of Users* graph. 
.. If you want, you can click the binoculars icon to display only this graph. 

TIP: If you are not collecting this metric, see xx for information. 

[[threshold-create]]
==== Create a Threshold

. Select *<User_Name>>Configure OpenNMS* from the top-right menu. 
. Under Performance Measurement, choose Configure Thresholds.
.. A screen with a list of preconfigured threshold groups appears.
We will work with `netsnmp`.
For infomation on how to create a threshold group, see <<threshold-group, Creating a threshold group>>. 
. Click `Edit` beside the `netsnmp` group. 
. Click Create New Threshold at the bottom of the Basic Thresholds area of the screen. 
. Set the following information and click *Save*:

|===

| *Field* | *Value* | *Description*

| Type | high | triggers an event when the value of the data source equals or exceeds the threshold value, and rearms when it equals or drops below the rearm value

| Datasource | hrSystemNumUsers| Name of the datasource you want to threshold against. 
For information on how to determine the datasource, see <<datasource-determine, Determine the Datasource>>
Where it comes from: mib2.xml - group name - there are tons of these - F5 (if you have that kind of load balancer) - data from other management protocols - outside the scope of this tutorial

| Datasource label| leave blank | Optional text label. 
Not required for this tutorial.

| Value| 2 | The value above which we want to trigger an event. 

| Re-arm | 2 | The value below which we want the system to re-arm. 

| Trigger | 3 | The number of consecutive times the threshold value can occur before the system triggers an event. 
Since our default polling period is 5 minutes, a value of 3 means OpenNMS 
would create a threshold event if there is more than 2 users for 15 minutes.

|Description | leave blank | optional text to describe your threshold 

|Triggered UEI| leave blank |

|Re-armed UEI | leave blank |

|===

[[datasource-determine]]
=== Determine the Datasource
Creating a threshold requires the name of the datasource generating the metrics on which you want to threshold. 
Datasource names appear in `etc/snmp-graph.properties.d/`.

. To determine the name of the datasource, find the title of the graph that displays the metric on which you want to threshold. 
For example, "Number of Processes" or "System Uptime":
+
image:thresholding/graphs.png[]

. Go to `etc/snmp-graph.properties.d/` and search for the title of the graph (for example, "System Uptime"):

[ capture image ]

Note the name of the datasource, and enter it in the `Datasource` field when you <<threshold-create, create your threshold>>.  

NOTE: To determine a datasource from a different management protocol, ...

* Specifying the nodes/interfaces on which you want to apply the threshold
* Creating a service definition
* Creating a threshold group
* Activating the thresholds

[[data-enable]]
==== Enable Data Collection

[[threshold-pkg]]
==== Specify Nodes/Interfaces for Threshold

[[threshold-service]]
==== Create a Service Definition

[[threshold-group]]
==== Create a Threshold Group
A threshold group associates a set of thresholds to a service (e.g., thresholds that apply to all Cisco devices). _{opennms-product-name}_ includes seven preconfigured, editable threshold groups:

* mib2 
* cisco 
* hrstorage 
* netsnmp 
* juniper-srx 
* netsnmp-memory-linux 
* netsnmp-memory-nonlinux 

You can edit an existing group or create a new one. 



=== Thresholding Service

The Thresholding Service is the component responsible for maintaining the state of the performance metrics and for generating alarms from these when thresholds are triggered (armed) or cleared (unarmed).

The thresholding service listens for and visits performance metrics _after_ they are persisted to the time series database.

The state of the thresholds are held in memory and pushed to persistent storage only when they are changed.

==== Distributed Thresholding with Sentinel

Thresholding for streaming telemetry with <<ga-telemetryd, telemetryd>> is supported on Sentinel when using <<ga-opennms-operation-newts, Newts>>.
When running on Sentinel, the thresholding state can be stored in either Cassandra or PostgreSQL.
Given that Newts already requires Cassandra, we recommend using Casssandra in order to help minimize the load on PostgreSQL.

Thresholding on Sentinel uses the same configuration files as _{opennms-product-name}_ and operates similarly.
When a thresholding changes to/from trigger or cleared, and event is published which is processed by _{opennms-product-name}_ and the alarm is created or updated.

=== Shell Commands

The following shell commands are made available to help debug and manage thresholding.

Enumerate the persisted threshold states using `opennms-threshold-states:enumerate`:

[source]
----
admin@opennms> opennms-threshold-states:enumerate 
Index   State Key
1       23-127.0.0.1-hrStorageIndex-hrStorageUsed / hrStorageSize * 100.0-/opt/opennms/share/rrd/snmp-RELATIVE_CHANGE
2       23-127.0.0.1-if-ifHCInOctets * 8 / 1000000 / ifHighSpeed * 100-/opt/opennms/share/rrd/snmp-HIGH
3       23-127.0.0.1-node-((loadavg5 / 100) / CpuNumCpus) * 100.0-/opt/opennms/share/rrd/snmp-HIGH
4       23-127.0.0.1-if-ifInDiscards + ifOutDiscards-/opt/opennms/share/rrd/snmp-HIGH
----

Each state is uniquely identified by a `state key` and aliased by the given `index`.
Indexes are scoped to the particular shell session and provided as an alternative to specifying the complete state key in subsequent commands.

Display state details using `opennms-threshold-states:details`:

[source]
----
admin@opennms> opennms-threshold-states:details 1
multiplier=1.333
lastSample=64.77758166043765
previousTriggeringSample=28.862826722171075
interpolatedExpression='hrStorageUsed / hrStorageSize * 100.0'
----

[source]
----
admin@opennms> opennms-threshold-states:details 2
exceededCount=0
armed=true
interpolatedExpression='ifHCInOctets * 8 / 1000000 / ifHighSpeed * 100'
----

NOTE: Different types of thresholds will display different properties.

Clear a particular persisted state using `opennms-threshold-states:clear`:

[source]
----
admin@opennms> opennms-threshold-states:clear 2
----

Or clear all the persisted states with `opennms-threshold-states:clear-all`:

[source]
----
admin@opennms> opennms-threshold-states:clear-all 
Clearing all thresholding states....done
----
