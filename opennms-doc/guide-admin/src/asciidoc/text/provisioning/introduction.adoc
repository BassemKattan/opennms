
// Allow GitHub image rendering
:imagesdir: ../../images

[[ga-provisioning-introduction]]
=== Introduction

Provisioning is a mechanism to import node and service definitions either from an external source such as DNS or HTTP or via the {opennms-product-name} web UI.
The _Provisiond_ daemon maintains your managed entity inventory through policy-based provisioning. 

Provisiond comes with a RESTful Web Service API for easy integration with external systems such as CRM or external inventory systems.
It also includes an adapter API for interfacing with other management systems such as configuration management.

==== How It Works

Provisiond receives requests to add managed entities (nodes, IP interfaces, SNMP interfaces, services) via two basic mechanisms: link:#discovery-auto[automatic disovery], typically via the Discovery daemon, and link:#discovery-directed[directed discovery] using an import requisition, typically via the Provisioning UI.

IMPORTANT: An import requisition is an XML definition of node entities to be provisioned from a foreign source into {opennms-product-name}.
See the http://xmlns.opennms.org/xsd/config/model-import[requisition schema] (XSD) for more information. 

The default foreign source definition is ... 

[[discovery-auto]]
==== Automatic Discovery

{opennms-product-name}, uses the ICMP to automatically provision node entities.
Automatically discovered entities are analyzed, persisted to the relational data store, and managed based on the policies defined in the default foreign source definition.

===== Separation of Concerns

Provisiond manages three separate phases: entity scanning, service detection, and node merging.

Immediately following the import of a node entity, tasks are created for scanning a node to discover the node entity’s interfaces (SNMP and IP).
As interfaces are found, they are persisted and tasks are scheduled for service detection of each IP interface.

For auto discovered nodes, a node merging phase is scheduled;
Nodes that have been directly provisioned will not be included in the node merging process.
Merging will only occur when 2 automatically discovered nodes appear to be the same node.

[[discovery-directed]]
==== Enhanced Directed Discovery

_Enhanced Directed discovery_ begins with an enhanced version of the same import requisition used in directed provisioning and completes with a policy influenced persistence phase that sorts though the details of all the entities and services found during the entity and service scanning phase.

If you are planning to use this form of provisioning, it important to understand the conceptual details of how _Provisiond_ manages entities it is _directed_ to provision.
This knowledge will enable administrators and systems integrators to better plan, implement, and resolve any issues involved with this provisioning strategy.

===== Understanding the Process

There are 3 phases involved with directing entities to be discovered: import, node scan, and service scan.
The import phase also has sub phases: marshal, audit, limited SNMP scan, and re-parent.

====== Marshal and Audit Phases

It is important to understand that the nodes requisitioned from each foreign source are managed as a complete set.
Nodes defined in a requisition from the foreign source _CRM_ and _CMDB_, for example, will be managed separately from each other even if they should contain exactly the same node definitions.
To {opennms-product-name}, these are individual entities and they are managed as a set.

Requisitions are referenced via a URL.
Currently, the URL can be specified as one of the following protocols: FILE, HTTP, HTTPS, and DNS.
Each protocol has a protocol handler that is used to stream the XML from a _foreign source_, i.e. http://inv.corp.org/import.cgi?customer=acme or `file:/opt/opennms/etc/imports/acme.xml`.
The DNS protocol is a special handler developed for Provisioning sets of nodes as a _foreign-source_ from a corporate DNS server.
See DNS Protocol Handler for details.

Upon the import request (either on schedule or on demand via an Event) the requisition is marshaled into Java objects for processing.
The nodes defined in the requisition represent what {opennms-product-name} should have as the current set of managed entities from that foreign source.
The audit phase determines for each node defined (or not defined) in the requisition which are to be processed as an _Add_, _Update_, or _Delete_ operation during the _Import Phase_.
This determination is made by comparing the set foreign IDs of each node in the requisition set with the set of foreign IDs of currently managed entities in {opennms-product-name}.

The intersection of the IDs from each set will become the Update operations, the extra set of foreign IDs that are in the requisition become the Add operations, and the extra set of foreign IDs from the managed entities become the Delete operations.
This implies that the foreign IDs from each foreign source must be unique.

Naturally, the first time an import request is processed from a foreign source there will be zero (0) node entities from the set of nodes currently being managed and each node defined in the requisition will become an Add Operation.
If a requisition is processed with zero (0) node definitions, all the currently managed nodes from that foreign source will become Delete operations (all the nodes, interfaces, outages, alarms, etc. will be removed from {opennms-product-name}).

When nodes are provisioned using the Provisioning Groups Web-UI, the requisitions are stored on the local file system and the file protocol handler is used to reference the requisition.
Each Provisioning Group is a separate foreign source and unique foreign IDs are generated by the Web-UI.
An MSP might use Provisioning Groups to define the set of nodes to be managed by customer name where each customer’s set of nodes are maintained in a separate Provisioning Group.

====== Import Phase

The import phase begins when Provisiond receives a request to import a requisition from a URL.
The first step in this phase is to load the requisition and marshal all the node entities defined in the requisition into Java objects.

If any syntactical or XML structural problems occur in the requisition, the entire import is abandoned and no import operations are completed.

Once the requisition is marshaled, the requisition nodes are audited against the persisted node entities.
The set of requisitioned nodes are compared with a subset of persisted nodes and this subset is generated from a database query using the foreign source defined in the requisition.
The audit generates one of three operations for each requisition node: _insert_, _update_, _delete_ based on each requisitioned node’s foreign ID.
Delete operations are created for any nodes that are not in the requisition but are in the DB subset, update operations are created for requisition nodes that match a persisted node from the subset (the intersection), and insert operations are created from the remaining requisition nodes (nodes in the requisition that are not in the DB subset).

If a requisition node has an interface defined as the Primary SNMP interface, then during the update and insert operations the node will be scanned for minimal SNMP attribute information.
This scan find the required node and SNMP interface details required for complete SNMP support of the node and only the IP interfaces defined in the requisition.

NOTE: this not the same as Provisiond SNMP discovery scan phases: node scan and interface scan.

====== Node Scan Phase

Where directed discovery leaves off and enhanced directed discovery begins is that after all the operations have completed, directed discovery is finished and enhanced directed discovery takes off.
The requisitioned nodes are scheduled for node scans where details about the node are discovered and interfaces that were not directly provisioned are also discovered.
All physical (SNMP) and logical (IP) interfaces are discovered and persisted based on any _Provisioning Policies_ that may have been defined for the foreign source associated with the import requisition.

====== Service Scan (detection) Phase

Additionally, the new Provisiond enhanced directed discovery mechanism follows interface discovery with service detection on each IP interface entity.
This is very similar to the Capsd plugin scanning found in all former releases of OpenNMS except that the foreign source definition is used to define what services should be detected on these interfaces found for nodes in the import requisition.


For more details on how provisioning works in {opennms-product-name}, see the https://www.opennms.com/[provisioning white paper]. 
