##
# Pre-stage image to extract and manipulate Minion directory structure
# Normally we install to /opt/minion and not /opt/minion-26.0.0-SNAPSHOT
# To avoid issues, we rearrange the directories in pre-stage to avoid injecting these
# as addtional layers into the final image.
##
ARG BASE_IMAGE="opennms/deploy-base"
ARG BASE_IMAGE_VERSION="1.0.0"

FROM ${BASE_IMAGE}:${BASE_IMAGE_VERSION} as minion-base

ADD ./tarball/minion.tar.gz /opt/

RUN mv /opt/minion-* /opt/minion

RUN groupadd --gid 10001 minion && \
    useradd --system --uid 10001 --gid minion minion && \
    chown 10001 /opt/minion -R && \
    chgrp -R 0 /opt/minion && \
    chmod -R g=u /opt/minion

##
# Prod image with minimal image size
##
FROM ${BASE_IMAGE}:${BASE_IMAGE_VERSION}

RUN groupadd --gid 10001 minion && \
    useradd --system --uid 10001 --gid minion minion

COPY assets/* /

# If you copy from /opt/minion to /opt/minion the permissions are not preserved
# We would have 755 for minion:root instead of 775 and prevents writing lock files in /opt/minion
COPY --from=minion-base /opt /opt

# Install confd
ARG CONFD_VERSION="0.16.0"
ARG CONFD_ARCH="amd64"
ARG CONFD_URL="https://github.com/kelseyhightower/confd/releases/download/v${CONFD_VERSION}/confd-${CONFD_VERSION}-linux-${CONFD_ARCH}"
ADD ${CONFD_URL} /usr/local/bin/confd
RUN chmod +x /usr/local/bin/confd
COPY ./confd/ /opt/minion/confd/
RUN chmod +x /opt/minion/confd/scripts/*

# Arguments for labels should not invalidate caches
ARG BUILD_DATE="1970-01-01T00:00:00+0000"
ARG VERSION
ARG SOURCE
ARG REVISION
ARG BUILD_JOB_ID
ARG BUILD_NUMBER
ARG BUILD_URL
ARG BUILD_BRANCH

LABEL org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.title="OpenNMS Minion ${VERSION}" \
      org.opencontainers.image.source="${SOURCE}" \
      org.opencontainers.image.revision="${REVISION}" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.vendor="The OpenNMS Group, Inc." \
      org.opencontainers.image.authors="OpenNMS Community" \
      org.opencontainers.image.licenses="AGPL-3.0" \
      org.opennms.image.base="${BASE_IMAGE}:${BASE_IMAGE_VERSION}" \
      org.opennme.cicd.jobid="${BUILD_JOB_ID}" \
      org.opennms.cicd.buildnumber="${BUILD_NUMBER}" \
      org.opennms.cicd.buildurl="${BUILD_URL}" \
      org.opennms.cicd.branch="${BUILD_BRANCH}"

USER 10001
WORKDIR /opt/minion

ENTRYPOINT [ "/entrypoint.sh" ]

STOPSIGNAL SIGTERM

CMD [ "-f" ]

### Runtime information and not relevant at build time
ENV MINION_ID="00000000-0000-0000-0000-deadbeef0001" \
    MINION_LOCATION="MINION" \
    OPENNMS_BROKER_URL="tcp://127.0.0.1:61616" \
    OPENNMS_HTTP_URL="http://127.0.0.1:8980/opennms" \
    OPENNMS_HTTP_USER="minion" \
    OPENNMS_HTTP_PASS="minion" \
    OPENNMS_BROKER_USER="minion" \
    OPENNMS_BROKER_PASS="minion"

##------------------------------------------------------------------------------
## EXPOSED PORTS
##------------------------------------------------------------------------------
## -- OpenNMS KARAF SSH    8201/TCP
## -- OpenNMS JMX         18980/TCP
## -- SNMP Trapd           1162/UDP
## -- Syslog               1514/UDP
EXPOSE 8201/tcp 1162/udp 1514/udp
