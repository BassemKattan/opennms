
= Provisioning examples

Here are a few practical examples of provisioning nodes to help with your understanding of this process.

== Basic provisioning

This example adds three nodes and requires no {page-component-title} configuration other than specifying the node entities to be provisioned and managed in {page-component-title}.

=== Defining the nodes via the web UI

Using the Requisition Web UI, three nodes are created given a single IP address.
Navigate to the Admin Menu and click `Manage Provisioning Requisitions` from the list of Provisioning options and create the group "Bronze".

.Creating a new requisition
image:provisioning/00006.jpeg[]

Clicking the `Add Requisition` button will prompt for a name to create a blank requisition, and will update the page to display the newly created entry at the end.

image:provisioning/00028.jpeg[]

NOTE: At this point, the XML structure for holding the new requisition group has been persisted to the `$OPENNMS_HOME/etc/imports/pending` directory.

Clicking the `Edit` link (pencil icon) will bring you to the screen where you can begin the process of defining node entities that will be imported into {page-component-title}.
Clicking the `Add Node` button will begin the node entity creation process.
Fill in the node label and click the `Save` button.

.Creating a new node definition in the requisition
image:provisioning/00026.jpeg[]

At this point, the requisition contains the basic structure of a node entity but it is not complete until the interface(s) and interface service(s) have been defined.
After having clicked the `Save` button, we can continue to populate node data in the `Path Outage`, `Interfaces`, `Assets`, `Categories`, and `Meta-Data` tabs as necessary.
Click the `Interfaces` tab and then the `Add Interface` button to add an interface entity to the node.

.Adding an interface to the node definition
image:provisioning/00009.jpeg[]

Type the IP address for this interface entity, an optional description, and specify the SNMP Primary attribute as `P` (Primary), `S` (Secondary), or `N` (Not eligible) and click the save button.
Only one interface on a node can be set as Primary, and this determines which IP will be used for collecting SNMP metrics.
There is an `Add Service` button that will let you specify services to monitor on this interface.
The foreign source definition's detectors will be checked against the interface to look for services not explicitly specified.
For this example, add `ICMP` and then click the `Add Service` button again to add `SNMP`.
Finally, click the `Save` button to save the interface, then the `Save` the `Return` buttons on the node page.

.A complete node definition with all required elements defined
image:provisioning/00007.jpeg[]

Now the node entity definition contains all the required elements necessary for importing this requisition into {page-component-title}.
At this point, all the interfaces that are required for the node in this example should be added.
For example, NAT interfaces should be specified if there are services that they provide because they will not be discovered during the Scan Phase.

Two more nodes will be added for the benefit of this example.

.The completed requisition for the Bronze example
image:provisioning/00021.jpeg[]

This set of nodes represents an import requisition for the Bronze requisition.
As this requisition is being edited via the Web UI, changes are being persisted into the {page-component-title} configuration directory `$OPENNMS_HOME/etc/imports/pending` as an XML file having the name `bronze.xml`.

NOTE: The name of the XML file containing the import requisition is the same as the requisition name.
Therefore naming your requisition without spaces makes them easier to manage on the file system.

Click the `Return` button to return to the Requisitions list screen.
The details of the Bronze group now indicate that there are three nodes in the requisition and that there are no nodes in the database from this group.
Additionally, you can see that time the requisition was last modified and the time it last imported are given (the time stamps are stored as attributes inside the requisition and are not the file system time stamps).
These details are indicative of how well the database represents what is in the requisition.

image:provisioning/00013.jpeg[]

NOTE: You can tell that this is a pending requisition for two reasons: There number of nodes defines and in the database do not match, and the requisition has been modified since the last import (in this case `never`).

=== Import the nodes

In this example, you see that there are three nodes in the pending requisition and zero in the database.
Click the `Synchronize` button (double arrows) to submit the requisition to the provisioning system.
This sends an event to the Provisiond system, telling it to begin the Import Phase for this requisition.

NOTE: Do not refresh this page to check the values of these details.
To refresh the details to verify the import, go to another page and then return to the Requisitions page.

You should be able to immediately verify the import was successful as this import happens very quickly since there is only a small number of nodes.
Provisiond has several threads ready for processing the import operations of the nodes, and more nodes in a requisition and detectors in the foreign source definition will take more time to complete the import process.

A few SNMP packets are sent and received to get the SNMP details of the node and the interfaces defined in the requisition.
Upon receipt of these packets, or not, each node is inserted as a database transaction.

.The nodes are now added to {page-component-title} and are under management
image:provisioning/000014.png[]

Following the import of a node with thousands of interfaces, you will be able to refresh the Interface table browser on the Node page and see that interfaces and services are being discovered and added in the background.
This is the discovery component of directed discovery.

=== Adding a node

To add another node from a foreign source, in this example the Bronze requisition, simply add a new node definition to the existing requisition and re-synchronize.
It is important to remember that all the node definitions will be re-imported, and the existing managed nodes will be updated if necessary.

=== Changing a node

To apply changes to an existing node, simply add, change, or delete the necessary attributes of the node definition and re-synchronize.
For example, to change the IP address of the Primary SNMP interface for the node, _barbrady.opennms.com_, just change the requisition and re-import.

Each element in the Web UI has an associated Edit icon
Click this icon to change the IP address for _barbrady.opennms.com_, click save, and then Click the Done button.

.Changing the IP address of _barbrady.opennms.com_ from 10.1.1.2 to 192.168.1.1
image:provisioning/00027.jpeg[]

The Web UI will return you to the Provisioning Requisitions screen where you will see that there are the time stamp showing that the requisition’s last modification is more recent that the last import time.

.The Requisition must be re-imported
image:provisioning/000012.png[]

This provides an indication that the group must be re-imported for the changes made to the requisition to take effect.
The IP Interface will be simply updated and all the required events (messages) will be sent to communicate this change within {page-component-title}.

.The IP interface for barbrady.opennms.com is immediately updated
image:provisioning/000008.png[]

=== Deleting a node

_Barbrady_ has not been behaving, as one might expect, so it is time to remove him from the system.
Edit the requisition, click the delete button next to the node _barbrady.opennms.com_, click the `Done` button.

.Bronze Requisition definition indicates a node has been removed and requires an import to delete the node entity from the {page-component-title} system
image:provisioning/000010.png[]

Click the Import button for the Bronze group and the Barbrady node and its interfaces, services, and any other related data will be immediately deleted from the {page-component-title} system.
All the required Events (messages) will be sent by Provisiond to provide indication to the {page-component-title} system that the node Barbrady has been deleted.

.Barbrady has been deleted
image:provisioning/000011.png[]

=== Deleting all the nodes

There is a convenient way to delete all the nodes that have been provided from a specific foreign source.
From the main Admin/Requisitions screen in the Web UI, click the `Delete Nodes` button.
This button deletes all the nodes defined in the Bronze requisition.
It is very important to note that once this is done, it cannot be undone!
Well it can’t be undone from the Web UI and can only be undone if you’ve been good about keeping a backup copy of your `$OPENNMS_ETC/` directory tree.
If you’ve made a mistake, before you re-import the requisition, restore the `Bronze.xml` requisition from your backup copy to the `$OPENNMS_HOME/etc/imports` directory.

.All node definitions have been removed from the Bronze requisition. The Web UI indicates an import is now required to remove them from {page-component-title}.
image:provisioning/000019.png[]

Clicking the `Import` button will cause the Audit Phase of Provisiond to determine that all the nodes from the Bronze requisition should be deleted from the database and will create `Delete` operations.
At this point, if you are satisfied that the nodes have been deleted and that you will no longer require nodes to be defined in this Group, you will see that the `Delete Nodes` button has now changed to the _Delete Group_ button.
The _Delete Group_ button is displayed when there are no nodes entities from that group (foreign source) in {page-component-title}.

When no node entities from the group exist in {page-component-title}, then the _Delete Group_ button is displayed.

== Advanced provisioning example

In the previous example, we provisioned three nodes and let Provisiond complete all of its import phases using a default foreign source definition.
Each Requisition can have a separate foreign source definition that controls:

* The rescan interval
* The services to be detected
* The policies to be applied

This example will demonstrate how to create a foreign source definition and how it is used to control the behavior of Provisiond when importing a requisition.

First let’s simply provision the node and let the default foreign source definition apply.

.The node definition used for the Advanced Provisioning Example
image:provisioning/00025.jpeg[]

Following the import, All the IP and SNMP interfaces, in addition to the interface specified in the requisition, have been discovered and added to the node entity.
The default foreign source definition has no polices for controlling which interfaces that are discovered either get persisted or managed by {page-component-title}.

image:provisioning/000005.png[]

.Logical and Physical interface and Service entities directed and discovered by Provisiond.
image:provisioning/000002.png[]

image:provisioning/000018.png[]

=== Service detection

As IP interfaces are found during the node scan process, service detection tasks are scheduled for each IP interface.
The service detections defined in the foreign source determines which services are to be detected and how.
The values of the parameters control how the service is detected, port, timeout, and so forth.

==== Applying a new foreign source definition

This example node has been provisioned using the Default foreign source definition.
By navigating to the Requisitions screen in the {page-component-title} Web UI and clicking the Edit Foreign Source link of a group, you can create a new foreign source definition that defines service detection and policies.
The policies determine entity persistence and/or set attributes on the discovered entities that control {page-component-title} management behaviors.

.When creating a new foreign source definition, the default definition is used as a template
image:provisioning/000017.png[]

In this UI, new Detectors can be added, changed, and removed.
For this example, we will remove detection of all services accept ICMP and DNS, change the timeout of ICMP detection, and a new Service detection for {page-component-title} Web UI.

.Custom foreign source definition
image:provisioning/00022.jpeg[]

Click the Done button and re-import the NMS Requisition.
During this and any subsequent re-imports or re- scans, the {page-component-title} detector will be active, and the detectors that have been removed will no longer test for the related services for the interfaces on nodes managed in the requisition, however, the currently detected services will not be removed.
There are 2 ways to delete the previously detected services:

. Delete the node in the requisition, re-import, define it again, and finally re-import again.
. Use the ReST API to delete unwanted services.
Use this command to remove each unwanted service from each interface, iteratively:

[source, bash]
----
curl -X DELETE -H "Content-Type: application/xml" -u admin:admin http://localhost:8980/opennms/rest/nodes/6/ipinterfaces/172.16.1.1/services/DNS
----

TIP: There is a sneaky way to do #1.
Edit the requisition and just change the foreign ID.
That will make Provisiond think that a node was deleted and a new node was added in the same requisition!
Use this hint with caution and an full understanding of the impact of deleting an existing node.

==== Provisioning with policies

The Policy API in Provisiond allow you to control the persistence of discovered IP and SNMP Interface entities and Node Categories during the Scan phase.

==== Matching IP interface policy

The Matching IP Interface policy controls whether discovered interfaces are to be persisted and if they are to be persisted, whether or not they will be forced to be Managed or Unmanaged.

Continuing with this example Requisition, we are going to define a few policies that:

a. Prevent discovered 10 network addresses from being persisted.
b. Force 192.168 network addresses to be unmanaged.

From the foreign source definition screen, click the `Add Policy` button and the definition of a new policy will begin with a field for naming the policy and a drop down list of the currently installed policies.
Name the policy _no10s_, make sure that the `Match IP Interface Policy` is specified in the class list and click the Save button.
This action will automatically add all the parameters required for the policy.

The two required parameters for this policy are action and matchBehavior.

.The action parameter can be set to `DO_NOT_PERSIST`, `MANAGE`, or `UNMANAGED`.
image:provisioning/00001.jpeg[]

==== Creating a policy to prevent persistence of 10.* network IP interfaces.

The `DO_NOT_PERSIST` action does just what it indicates, it prevents discovered IP interface entities from being added to {page-component-title} when the matchBehavior is satisfied.
The `MANAGE` and `UNMANAGE` values for this action allow the IP interface entity to be persisted by control whether or not that interface should be managed by {page-component-title}.

The matchBehavior action is a boolean control that determines how the optional parameters will be evaluated.
Setting this parameter’s value to `ALL_PARAMETERS` causes Provisiond to evaluate each optional parameter with boolean _AND_ logic and the value `ANY_PARAMETERS` will cause _OR_ logic to be applied.

Now we will add one of the optional parameters to filter the 10.* network addresses.
The Matching IP Interface policy supports two additional parameters, `hostName` and `ipAddress`.
Click the `Add Parameter` link and choose `ipAddress` as the key.
The value for either of the optional parameters can be an exact or regular expression match.
As in most configurations in {page-component-title} where regular expression matching can be optionally applied, prefix the value with the `~` character.

.Example matching IP interface policy to not persist 10.* network addresses
image:provisioning/00023.jpeg[]

Any subsequent scan of the node or re-imports of the requisition will force this policy to be applied.
IP Interface entities that already exist that match this policy will not be deleted.
Existing interfaces can be deleted by recreating the node in the Requisition screen (simply change the foreign ID and re-import the group) or by using the ReST API:

[source, bash]
----
curl -X DELETE -H "Content-Type: application/xml" -u admin:admin http://localhost:8980/opennms/rest/nodes/6/ipinterfaces/10.1.1.1
----

The next step in this example is to define a policy that sets discovered 192.168 network addresses to be unmanaged (not managed) in {page-component-title}.
Again, click the Add Policy button and let’s call this policy _noMgt192168s_.
Again, choose the Mach IP Interface policy and this time set the action to `UNMANAGE`.

.Policy to not manage IP interfaces from 192.168.* networks
image:provisioning/00015.jpeg[]

NOTE: The `UNMANAGE` behavior will be applied to existing interfaces.

==== Matching SNMP interface policy

Like the Matching IP Interface Policy, this policy controls the whether discovered SNMP interface entities are to be persisted and whether or not {page-component-title} should collect performance metrics from the SNMP agent for Interface’s index (MIB2 IfIndex).

In this example, we are going to create a policy that doesn’t persist interfaces that are _AAL5_ over _ATM_ or type _49_ (_ifType_).
Following the same steps as when creating an IP Management Policy, edit the foreign source definition and create a new policy.
Let’s call it: _noAAL5s_.
We’ll use Match SNMP Interface class for each policy and add a parameter with _ifType_ as the key and _49_ as the value.

.Matching SNMP interface policy example for persistence and data collection
image:provisioning/00003.jpeg[]

NOTE: At the appropriate time during the scanning phase, Provisiond will evaluate the policies in the foreign source definition and take
appropriate action.
If during the policy evaluation process any policy matches for a `DO_NOT_PERSIST` action, no further policy evaluations will happen for that particular entity (IP Interface, SNMP Interface).

==== Node categorization policy

With this policy, node entities will automatically be assigned categories.
The policy is defined in the same manner as the IP and SNMP interface polices.
Click the `Add Policy` button and give the policy name, `cisco` and choose the `Set Node Category` class.
Edit the required category key and set the value to `Cisco`.
Add a policy parameter and choose the sysObjectId key with a value `~^\.1\.3\.6\.1\.4\.1\.9\..*`.

Another use of this policy is to mark interfaces for polling by the SNMP Interface Poller.
The SNMP Interface Poller is a separate daemon that is disabled by default.
In order for this daemon to do any work, some SNMP interfaces need to be selected for polling.

Use the `ENABLE_POLLING` and `DISABLE_POLLING` actions available in this policy to manage which SNMP interfaces this daemon polls.

Let's create another policy named "pollVoIPDialPeers" that marks interfaces with an ifType of 104 for polling.
We'll set the action to `ENABLE_POLLING` and `matchBehavior` to `ALL_PARAMETERS`.
Add a parameter for `ifType` as the key and `104` as the value.

If you later decide to move all your meetings and therefore have no use for voice circuits, you will want to stop polling these interfaces.
To do so, change the action to `DISABLE_POLLING`.

.Example: Node category setting policy
image:provisioning/00020.jpeg[]

==== Script policy

This policy lets you use Groovy scripts to modify provisioned node data.
These scripts have to be placed in the {page-component-title} `etc/script-policies` directory.
An example would be the change of the node's primary interface or location.
The script will be invoked for each matching node.
The following example shows the source code for setting the `192.168.100.0/24` interface to `PRIMARY` while all remaining interfaces are set to `SECONDARY`.
Furthermore the node's location is set to `Minneapolis`.

[source, groovy]
----
import org.opennms.netmgt.model.OnmsIpInterface;
import org.opennms.netmgt.model.monitoringLocations.OnmsMonitoringLocation;
import org.opennms.netmgt.model.PrimaryType;

for(OnmsIpInterface iface : node.getIpInterfaces()) {
    if (iface.getIpAddressAsString().matches("^192\\.168\\.100\\..*")) {
        LOG.warn(iface.getIpAddressAsString() + " set to PRIMARY")
        iface.setIsSnmpPrimary(PrimaryType.PRIMARY)
    } else {
        LOG.warn(iface.getIpAddressAsString() + " set to SECONDARY")
        iface.setIsSnmpPrimary(PrimaryType.SECONDARY)
    }
}

node.setLocation(new OnmsMonitoringLocation("Minneapolis", ""));

return node;
----

==== Node metadata policy

The Metadata Policy lets you set node-level metadata in the context `requisition` for provisioned nodes.
It uses the same matching mechanism as the Node Categorization Policy.

==== Interface metadata policy

The Metadata Policy lets you set interface-level metadata in the context `requisition` for provisioned nodes.
It uses the same matching mechanism as the Matching IP Interface Policy.

=== New import capabilities

Several new XML entities have been added to the import requisition since the introduction of the OpenNMS Importer service in version 1.6.
So, in addition to provisioning the basic node, interface, service, and node categories, you can now also provision asset data.

==== Provisiond configuration

The configuration of the Provisioning system has moved from a properties file (`model-importer.properties`) to an XML based configuration container.
The configuration is now extensible to allow the definition of zero or more import requisitions each with their own _Cron_ based schedule for automatic importing from various sources (intended for integration with external URL such as HTTP and this new DNS protocol handler.

A default configuration is provided in the {page-component-title} `etc/` directory and is called: `provisiond-configuration.xml`.
This default configuration has an example for scheduling an import from a DNS server running on the localhost requesting nodes from the zone, localhost and will be imported once per day at the stroke of midnight.
Not very practical but is a good example.

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
    <provisiond-configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://xmlns.opennms.org/xsd/config/provisiond-configuration"
        foreign-source-dir="/opt/opennms/etc/foreign-sources"
        requisition-dir="/opt/opennms/etc/imports"
        importThreads="8"
        scanThreads="10"
        rescanThreads="10"
        writeThreads="8" >
    <!--
        http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger[http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger]
        Field Name Allowed Values Allowed Special Characters
        Seconds 0-59 , - * / Minutes 0-59 , - * / Hours 0-23 , - * /
        Day-of-month1-31, - * ? / L W C Month1-12 or JAN-DEC, - * /
        Day-of-Week1-7 or SUN-SAT, - * ? / L C # Year (Opt)empty, 1970-2099, - * /
    -->

    <requisition-def import-name="NMS"
                     import-url-resource="file://opt/opennms/etc/imports/NMS.xml">
        <cron-schedule>0 0 0 * * ? *</cron-schedule> <!-- daily, at midnight -->
    </requisition-def>
</provisiond-configuration>
----

==== Configuration reload

Like many of the daemon configurations in the 1.7 branch, _Provisiond’s_ configuration is re-loadable without having to restart OpenNMS.
Use the reloadDaemonConfig uei:

[source, bash]
----
opt/opennms/bin/send-event.pl uei.opennms.org/internal/reloadDaemonConfig --parm 'daemonName Provisiond'
----

This means that you don't have to restart {page-component-title} every time you update the configuration!

==== Provisioning asset data

The Requisition Web UI lets you configure Node Asset data in an import requisition.
Click the `Add Asset` button in the Assets section while editing a node, and you can select from a drop down list all the possible node asset attributes that can be defined.

image:provisioning/00024.jpeg[]

After an import, you can navigate to the node's page and click the `Asset Info` link to see the asset data that was provided in the requisition.

image:provisioning/000004.png[]

=== External requisition sources

Because Provisiond accepts a URL as the location service for import requisitions, {page-component-title} can easily be extended to support other sources in addition to the native URL handling provided by Java: _file://_, _http://_, and _https://_.
When configuring Provisiond to import requisitions on a schedule, you specify the source using a URL resource.
For requisitions created by the Requisitions Web UI, you can specify a file based URL.

==== Provisioning nodes from DNS

See the xref:operation:provisioning/import-handler.adoc[import handlers] documentation for samples on how to import nodes from DNS server A and AAAA records.
